<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KUPID PDF Viewer</title>
    <link rel="preload" href="./fonts/Pretendard-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="./fonts/Pretendard-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <style>
      @font-face {
        font-family: 'Pretendard';
        src: url('./fonts/Pretendard-Regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Pretendard';
        src: url('./fonts/Pretendard-Bold.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      html, body { height: 100%; margin: 0; }
      body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
      #viewerContainer { position: fixed; inset: 0; background: #121212; overflow: auto; }
      #toolbar { position: fixed; left: 0; right: 0; top: 0; height: 48px; display: flex; align-items: center; gap: 8px; padding: 0 12px; background: #1e1e1e; color: #fff; z-index: 10; }
      #pageHost { position: absolute; top: 48px; left: 0; right: 0; margin: 16px auto; width: fit-content; }
      .page { position: relative; margin: 0 auto 16px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
      canvas { display: block; }
      .textLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; color: transparent; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important; }
      .textLayer span { position: absolute; white-space: pre; transform-origin: 0 0; color: #000; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important; }
      #toolbar button, #toolbar input, #pageInfo { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
      button, input { font-family: inherit; }
    </style>
  </head>
  <body>
    <div id="toolbar">
      <button id="back">뒤로</button>
      <button id="home">홈</button>
      <span style="width:8px"></span>
      <button id="prev">이전</button>
      <span id="pageInfo"></span>
      <button id="next">다음</button>
      <button id="zoomOut">-</button>
      <button id="zoomIn">+</button>
      <span style="flex:1"></span>
      <label style="display:flex;align-items:center;gap:6px;color:#ddd;user-select:none">
        <input id="forcePretendard" type="checkbox" checked /> 폰트 강제
      </label>
      <input id="fileInput" type="file" accept="application/pdf" />
    </div>
    <div id="viewerContainer">
      <div id="pageHost"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
    <script>
      (function(){
        const urlParams = new URLSearchParams(window.location.search);
        const externalUrl = urlParams.get('file');
        const pageHost = document.getElementById('pageHost');
        const pageInfo = document.getElementById('pageInfo');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const backBtn = document.getElementById('back');
        const homeBtn = document.getElementById('home');
        const fileInput = document.getElementById('fileInput');
        const forcePretendardChk = document.getElementById('forcePretendard');

        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.25;
        let forcePretendard = true;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js';

        function clearPageHost(){
          while (pageHost.firstChild) pageHost.removeChild(pageHost.firstChild);
        }

        function renderPage(num){
          pdfDoc.getPage(num).then(function(page){
            const viewport = page.getViewport({ scale });

            clearPageHost();
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            pageDiv.style.width = viewport.width + 'px';
            pageDiv.style.height = viewport.height + 'px';

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pageDiv.appendChild(canvas);

            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'textLayer';
            pageDiv.appendChild(textLayerDiv);

            pageHost.appendChild(pageDiv);

            const renderContext = { canvasContext: ctx, viewport };
            const renderTask = page.render(renderContext);

            page.getTextContent({ normalizeWhitespace: true }).then(function(textContent){
              const textLayer = new pdfjsLib.renderTextLayer({
                textContent,
                container: textLayerDiv,
                viewport,
                textDivs: []
              });
              renderTask.promise.then(function(){
                textLayer.render().then(function(){
                  textLayerDiv.querySelectorAll('span').forEach(function(el){
                    el.style.fontFamily = "Pretendard, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";
                    el.style.color = forcePretendard ? '#000' : '';
                  });
                  // 캔버스/텍스트 표시 전환
                  if (forcePretendard) {
                    canvas.style.display = 'none';
                    textLayerDiv.style.color = '#000';
                  } else {
                    canvas.style.display = 'block';
                    textLayerDiv.style.color = 'transparent';
                  }
                });
              });
            });

            pageInfo.textContent = num + ' / ' + pdfDoc.numPages;
          });
        }

        async function fetchViaIPC(url){
          try {
            if (!(window.electronAPI && window.electronAPI.fetchPdfBase64)) return null;
            const res = await window.electronAPI.fetchPdfBase64(url);
            if (!res || !res.ok) return null;
            const blob = dataURItoBlob('data:application/pdf;base64,' + res.base64);
            return URL.createObjectURL(blob);
          } catch (e) { return null; }
        }

        function dataURItoBlob(dataURI) {
          const parts = dataURI.split(','), mime = parts[0].match(/:(.*?);/)[1];
          const byteString = atob(parts[1]);
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);
          for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
          return new Blob([ab], { type: mime });
        }

        async function fetchWithSession(url){
          try {
            const cookieHeader = window.electronAPI && window.electronAPI.getCookieHeader ? await window.electronAPI.getCookieHeader(url) : '';
            const res = await fetch(url, { method: 'GET', credentials: 'include', headers: cookieHeader ? { 'Cookie': cookieHeader } : undefined });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const buf = await res.arrayBuffer();
            const blob = new Blob([buf], { type: 'application/pdf' });
            return URL.createObjectURL(blob);
          } catch (e) { return null; }
        }

        async function loadPdf(src){
          try {
            let source = src;
            if (/^https?:/i.test(src)) {
              source = await fetchViaIPC(src) || await fetchWithSession(src);
              if (!source) throw new Error('세션 fetch 실패');
            }
            pdfjsLib.getDocument({ url: source }).promise.then(function(pdf){
              pdfDoc = pdf;
              currentPage = 1;
              renderPage(currentPage);
            }).catch(function(err){
              console.error('PDF 로드 오류:', err);
              alert('PDF 로드에 실패했습니다.');
            });
          } catch (e) {
            alert('PDF 가져오기에 실패했습니다.');
          }
        }

        zoomInBtn.addEventListener('click', function(){ scale = Math.min(scale + 0.25, 5); renderPage(currentPage); });
        zoomOutBtn.addEventListener('click', function(){ scale = Math.max(scale - 0.25, 0.25); renderPage(currentPage); });
        prevBtn.addEventListener('click', function(){ if (!pdfDoc) return; currentPage = Math.max(1, currentPage - 1); renderPage(currentPage); });
        nextBtn.addEventListener('click', function(){ if (!pdfDoc) return; currentPage = Math.min(pdfDoc.numPages, currentPage + 1); renderPage(currentPage); });
        forcePretendardChk.addEventListener('change', function(e){ forcePretendard = !!e.target.checked; if (pdfDoc) renderPage(currentPage); });
        fileInput.addEventListener('change', function(e){ const f = e.target.files && e.target.files[0]; if (f) loadPdf(URL.createObjectURL(f)); });
        backBtn.addEventListener('click', function(){ if (window.electronAPI && window.electronAPI.viewerGoBack) window.electronAPI.viewerGoBack(); });
        homeBtn.addEventListener('click', function(){ if (window.electronAPI && window.electronAPI.viewerGoHome) window.electronAPI.viewerGoHome(); });

        if (externalUrl) loadPdf(externalUrl);
      })();
    </script>
  </body>
  </html>


